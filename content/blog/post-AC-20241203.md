---
title: "hasura v2ã®ã™ã‚ã‚"
date: 2024-12-03T11:01:12+09:00
draft: farse

# ãƒ¡ã‚¤ãƒ³ç”»åƒç”»åƒ
image: "https://hackmd.io/_uploads/B1A1QhFXyx.png"

# meta description
description: "çš†æ§˜ã“ã‚“ã«ã¡ã¯ã€‚NUTMEGä¸‰å¹´ç›®ã®æ¯”å˜‰è¯ã§ã™ã€‚ã‚¢ãƒ‰ã‚«ãƒ¬3æ—¥ç›®ã«ãªã‚Šã¾ã™ã€‚ã¾ã åºã®ç« ã§ã‚ã‚Šã¾ã™ãŒæ˜¯éã”ä¸€èª­ãã ã•ã„ã€‚
ç§ãŸã¡ãŒBingoãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®é‹ç”¨ã‚’å§‹ã‚ã¦2å¹´ãŒçµŒã¡ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã«é–¢ã—ã¦ã¯ã‚ã‚‹ç¨‹åº¦ã®å®Œæˆç³»ãŒè¦‹ãˆã¦ãŠã‚Šã€ã“ã‚Œã‹ã‚‰ã¯ã‚¤ãƒ³ãƒ•ãƒ©é–¢é€£ã§å®‰å®šã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚æœ¬ãƒ–ãƒ­ã‚°ã§ã¯ã€Bingoãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹Hasura Engine v2ã®æ¦‚è¦ã¨æ§‹æˆã®ä¸€ä¾‹ã‚’å…±æœ‰ã—ã¾ã™ã€‚Hasuraè‡ªä½“ã®æ—¥æœ¬èªè¨˜äº‹ãŒå°‘ãªã„ + ç§è‡ªèº«ã®Hasuraã®å¾©ç¿’ã‚‚å…¼ã­ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚ã“ã®æ§‹æˆãŒçµ¶å¯¾çš„ãªæ­£è§£ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€ã‚ˆã‚Šè‰¯ã„æ–¹æ³•ãŒã‚ã‚Œã°ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚"

# taxonomies
# æŠ•ç¨¿ã®åˆ†é¡(ã‚¤ãƒ™ãƒ³ãƒˆetc)
categories:
  - "NUTMEG Advent Calendar 2024"
  - "ãƒ¡ãƒ³ãƒãƒ¼ã®è¶£å‘³"
  - "æ´»å‹•ã®æ§˜å­"
# ä½¿ç”¨è¨€èª,æŠ€è¡“ãªã©(html,css,ruby,goãªã©)
tags:
  - "TypeScript"
  - "Next.js"
  - "Docker"
  - "Hasura"
  - "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰"
  - "APIé–¢ä¿‚"
# è‘—è€…å
authors:
  - "hikahana"


type: "post"
---
## ã¯ã˜ã‚ã«
çš†æ§˜ã“ã‚“ã«ã¡ã¯ã€‚NUTMEG 3å¹´ç›®ã®æ¯”å˜‰è¯ã§ã™ã€‚ã‚¢ãƒ‰ã‚«ãƒ¬3æ—¥ç›®ã«ãªã‚Šã¾ã™ã€‚ã¾ã åºã®ç« ã§ã‚ã‚Šã¾ã™ãŒæ˜¯éã”ä¸€èª­ãã ã•ã„ã€‚
ç§ãŸã¡ãŒBingoãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®é‹ç”¨ã‚’å§‹ã‚ã¦2å¹´ãŒçµŒã¡ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã«é–¢ã—ã¦ã¯ã‚ã‚‹ç¨‹åº¦ã®å®Œæˆç³»ãŒè¦‹ãˆã¦ãŠã‚Šã€ã“ã‚Œã‹ã‚‰ã¯ã‚¤ãƒ³ãƒ•ãƒ©é–¢é€£ã§å®‰å®šã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚æœ¬ãƒ–ãƒ­ã‚°ã§ã¯ã€Bingoãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹Hasura Engine v2ã®æ¦‚è¦ã¨æ§‹æˆã®ä¸€ä¾‹ã‚’å…±æœ‰ã—ã¾ã™ã€‚**Hasuraè‡ªä½“ã®æ—¥æœ¬èªè¨˜äº‹ãŒå°‘ãªã„ + ç§è‡ªèº«ã®Hasuraã®å¾©ç¿’ã‚‚å…¼ã­ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚ã“ã®æ§‹æˆãŒçµ¶å¯¾çš„ãªæ­£è§£ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€ã‚ˆã‚Šè‰¯ã„æ–¹æ³•ãŒã‚ã‚Œã°ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚**

## Hasura GraphQL Engineã¨ã¯
ä»¥ä¸‹ã¯[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://hasura.io/docs/2.0/index/)ã®ç¿»è¨³ã§ã™ã€‚
Hasura GraphQL Engineã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’å³åº§ã«GraphQL APIã¨ã—ã¦åˆ©ç”¨å¯èƒ½ã«ã—ã€ãƒ¢ãƒ€ãƒ³ã§é«˜æ€§èƒ½ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„APIã‚’å¾“æ¥ã®10å€ã®é€Ÿã•ã§æ§‹ç¯‰ãƒ»æä¾›ã§ãã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚Hasuraã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€RESTãŠã‚ˆã³GraphQLã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã€ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£APIã«æ¥ç¶šã—ã€ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦çµ±åˆã•ã‚ŒãŸãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã‚»ã‚­ãƒ¥ã‚¢ãªGraphQL APIã‚’æä¾›ã—ã¾ã™ã€‚Hasuraã®ã‚³ã‚¢æ©Ÿèƒ½ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§é–‹ç™ºã•ã‚Œã¦ãŠã‚Šã€èª°ã§ã‚‚ç„¡æ–™ã§ä½¿ç”¨ã§ãã¾ã™ã€‚

è¦ã™ã‚‹ã«ã€Hasura Engineï¼ˆä»¥ä¸‹ã€Hasuraï¼‰ã¯ã€PostgreSQLã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è‡ªå‹•çš„ã«GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹ç¯‰ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Hasuraã‚’ä½¿ç”¨ã™ã‚‹éš›ã¯ã€Hasuraã¨PostgreSQLã‚’çµ„ã¿åˆã‚ã›ã¦åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚ãªãŠã€***ã€ŒHasuraã€ã¯ã€Œé˜¿ä¿®ç¾…ï¼ˆAshuraï¼‰ã€ã¨Haskellã‚’çµ„ã¿åˆã‚ã›ãŸé€ èªã§ã™ã€‚***

HasuraãŒè‡ªå‹•ã§GraphQLã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å‹•ä½œã™ã‚‹ãŸã‚ã€GraphQLã‚µãƒ¼ãƒãƒ¼ã‚’å®Ÿè£…ã™ã‚‹æ‰‹é–“ãŒçœã‘ã¾ã™ã€‚Hasuraã§è¨­å®šã™ã‚Œã°ã€ã™ãã«Queryã€Mutationã€Subscriptionã‚’ä½¿ãˆã‚‹ãŸã‚ã€é«˜ã„é–‹ç™ºåŠ¹ç‡ã§é–‹ç™ºã‚’é€²ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚Hasuraã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€ã‚¯ã‚¨ãƒªã«æ²¿ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’GraphQL Code Generatorã§è‡ªå‹•ç”Ÿæˆã§ãã‚‹ã®ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å®Ÿè£…ã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¾ãŸã€Hasuraã§ã¯Auth0ãªã©ã®èªè¨¼ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¨é€šä¿¡ã—ã€JWTã‚’åˆ©ç”¨ã—ã¦ã€å„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ã‚«ãƒ©ãƒ ã«å¯¾ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚„IDã«åŸºã¥ãè©³ç´°ãªã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¨­å®šã§ãã¾ã™ã€‚JWTã«å«ã¾ã‚Œã‚‹ `X-Hasura-User-Id` ã‚’ä½¿ç”¨ã—ã¦ã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªèº«ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—ãƒ»æ“ä½œã§ãã‚‹ã‚ˆã†ã«åˆ¶é™ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

## Hasuraã®ç’°å¢ƒæ§‹ç¯‰

Dockerç’°å¢ƒã§ã®Hasuraã®ç’°å¢ƒæ§‹ç¯‰ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã“ã®æ‰‹é †ã‚’è¸ã‚€ã“ã¨ã§ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ã™ã¹ã¦Hasuraã«ä¸€ä»»ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚

Bingoãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‹ã‚‰å¿…è¦ãªã‚‚ã®ã ã‘ã‚’æŠ½å‡ºã—ã¦ç°¡ç´ åŒ–ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯ã‚ã¾ã‚Šå‚è€ƒã«ã—ãªã„ã§ãã ã•ã„ã€‚æœ¬æ¥ã¯ã€App Routerã®ä½¿ç”¨ã‚„pnpmã§ã®ç®¡ç†ãªã©ã‚’è¡Œã£ãŸæ–¹ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ï¼

æœ¬æ§‹æˆã®ç‰¹å¾´ã¯ã€`docker compose build`ãŒä¸è¦ã«ãªã‚‹ã“ã¨ã§ã™ã€‚ãŸã ã—ã€ä½¿ã„å‹æ‰‹ã¯æ­£ç›´ã‚ã¾ã‚Šè‰¯ãã‚ã‚Šã¾ã›ã‚“ã€‚èµ·å‹•ã®ãŸã³ã«`npm ciã€npm run`ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•ã‹ã‚‰å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ã¾ã§ç´„1åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚


### æœ€çµ‚çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ â€»appã¯è§¦ã£ãŸéƒ¨åˆ†ã®ã¿ã‚’æ²è¼‰
```
ğŸ“api
    ğŸ“metadata
    ğŸ“migrations/default/hoge_auto
        ğŸ“„up.sql
    ğŸ“seed
    ğŸ“„config.yaml
ğŸ“app
    ğŸ“src
        ğŸ“gql
            ğŸ“„users.gql
        ğŸ“pages
            ğŸ“„_app.tsx
            ğŸ“„index.tsx
        ğŸ“type
            ğŸ“„graphql.ts
    ğŸ“„.eslintrc.json
    ğŸ“„next.config.ts
    ğŸ“„codegen.ts
ğŸ“settings
    ğŸ“„.env
ğŸ“„compose.yaml
ğŸ“„.gitignore
ğŸ“„Makefile
```
[Githubã«æŒ™ã’ãŸã‚‚ã®ã¯ã“ã¡ã‚‰ã§ã™ã€‚](https://github.com/hikahana/hasura_v3)

GitHubä¸Šã®ãƒªãƒã‚¸ãƒˆãƒªä½œæˆã¨first commitã¯å®Œäº†ã—ã¦ã„ã‚‹å‰æã§é€²ã‚ã¾ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªã®ä½œæˆã«ã¤ã„ã¦ä¸æ˜ãªæ–¹ã¯ã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.github.com/ja/repositories/creating-and-managing-repositories/creating-a-new-repository)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### 1. compose upã™ã‚‹ãŸã‚ã®æº–å‚™
1.1
ã¾ãšã€compose.yamlã‚’ä½œæˆã—ã€ä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã®æƒ…å ±ã‚’å®šç¾©ã—ã¾ã™ã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯Nextjsã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯Hasuraã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯PostgreSQLã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ã“ã‚Œã‚‰ã‚’å®šç¾©ã—ã¾ã™ã€‚

(ä»¥ä¸‹ã€compose.yamlã®å†…å®¹)
```
services:
  db:
    image: postgres:12
    container_name: "db"
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_HOST_AUTH_METHOD: trust
    healthcheck:
      test:
        - "CMD-SHELL"
        - "pg_isready"
      interval: 10s
      timeout: 5s
      retries: 5

  api: # hasura
    image: hasura/graphql-engine:v2.36.6@sha256:3fc234510962e66d5ca7db16734b8796a16fb729953915861953e974f976f30f
    container_name: "api"
    ports:
      - "8080:8080"
    volumes:
      - ./api:/hasura/api
    working_dir: /hasura/api
    env_file:
      - ./settings/.env
    entrypoint: >
      sh -c "
      curl -L https://github.com/hasura/graphql-engine/raw/stable/cli/get.sh | bash &&
      graphql-engine serve
      "

  app:
    image: node:20-alpine@sha256:b5b9467fe7b33aad47f1ec3f6e0646a658f85f05c18d4243024212a91f3b7554
    container_name: "app"
    volumes:
      - ./app:/app
    working_dir: /app
    command: sh -c "npm ci && npm run dev"
    ports:
      - "3000:3000"
    env_file:
      - ./settings/.env
    stdin_open: true
    tty: true

volumes:
  db-data:

```

---
1.2
ç’°å¢ƒå¤‰æ•°ã‚’é…ç½®ã™ã‚‹ãŸã‚ã€è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚compose.yamlã‚’ç¢ºèªã™ã‚‹ã¨ã€apiã¨appã®ç’°å¢ƒå¤‰æ•°ã¯`settings/.env`ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```bash
# ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç›´ä¸‹ã§
mkdir settings
cd settings
touch .env
```

.envãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
(ä»¥ä¸‹ã€.envã®å†…å®¹)
```
NEXT_PUBLIC_CSR_API_URL="http://localhost:8080"
NEXT_PUBLIC_SSR_API_URL="http://api:8080"
NEXT_PUBLIC_BASE_URL="http://localhost:8080"
API_URI="http://localhost:8080"
WATCHPACK_POLLING="true"
WS_API_URL="ws://localhost:8080"

HASURA_GRAPHQL_ENABLE_CONSOLE="true"
# "postgres://{db_user_name}:{db_user_password}@{seivice_name}:{db_port}/{db_name}"
HASURA_GRAPHQL_DATABASE_URL="postgres://user:password@db:5432/db"
HASURA_GRAPHQL_DEV_MODE="true"
HASURA_GRAPHQL_ENABLED_LOG_TYPES="startup, http-log, webhook-log, websocket-log, query-log"
HASURA_GRAPHQL_EXPERIMENTAL_FEATURES="naming_convention"
HASURA_GRAPHQL_CLI_ENVIRONMENT="default"
HASURA_GRAPHQL_ADMIN_SECRET="hogehoge"

```
â€»æ³¨æ„ç‚¹
**HASURA_GRAPHQL_DATABASE_URL**ã¯compose.yamlã®dbã®enviromentã§å®šç¾©ã—ãŸã‚‚ã®ã¨åŒä¸€ã«ã—ã¦ãã ã•ã„ã€‚ãã†ã§ãªã„ã¨dbã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã¾ã›ã‚“ã€‚
**HASURA_GRAPHQL_ADMIN_SECRET**ã¯é©å®œä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

---
1.3
gitã«ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„ã‚ˆã†ã€.gitignoreãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

(ä»¥ä¸‹ã€.gitignoreã®å†…å®¹)
```
settings/
```

---
1.4
Nextjsã®ç’°å¢ƒæ§‹ç¯‰ã‚’è¡Œã„ã¾ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã£ã¦ãã ã•ã„ã€‚

(ä»¥ä¸‹ã€Next.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã®å¯¾è©±å‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †)
```bash
npx create-next-app@latest app

Need to install the following packages:
  create-next-app@15.0.3
Ok to proceed? (y) y

âœ” Would you like to use TypeScript? â€¦ No / Yes
âœ” Would you like to use ESLint? â€¦ No / Yes
âœ” Would you like to use Tailwind CSS? â€¦ No / Yes
âœ” Would you like your code inside a `src/` directory? â€¦ No / Yes
âœ” Would you like to use App Router? (recommended) â€¦ No / Yes
âœ” Would you like to use Turbopack for next dev? â€¦ No / Yes
âœ” Would you like to customize the import alias (@/* by default)? â€¦ No / Yes
âœ” What import alias would you like configured? â€¦ @/*
```

---

1.5
æœ€å¾Œã«ã€Makefileã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã‚Œã¯å¾Œã®Hasuraæ“ä½œã§ä½¿ç”¨ã—ã¾ã™ã€‚

(ä»¥ä¸‹ã€Makefileã®å†…å®¹)
```
run:
	docker compose up -d
	sleep 10
	make db-apply

down:
	docker compose down

db/apply:
	docker compose exec api hasura metadata apply
	docker compose exec api hasura migrate apply --database-name default
	docker compose exec api hasura metadata reload

db/export:
	docker compose exec api hasura metadata export
	docker compose exec api hasura migrate create "auto" --from-server --database-name default

db/seed:
	docker compose exec api hasura seed apply

codegen:
	docker compose run --rm app npm run codegen

```

### 2. Hasuraã®èµ·å‹•
2.1
compose upå‰ã«å¿…è¦ãªæº–å‚™ãŒæ•´ã£ãŸã®ã§ã€å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã€Hasuraã®åˆæœŸèµ·å‹•ã‚’è¡Œã„ã¾ã™ã€‚

Hasura CLIã‚’ä½¿ç”¨ã—ã¦Hasuraã®ç’°å¢ƒã‚’ä½œæˆã—ã¾ã™ã€‚ä»Šå›ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ãŸã‚ã€`docker compose run --rm`ã§ã¯ã†ã¾ãå‹•ä½œã—ã¾ã›ã‚“ã€‚

`hasura init --directory .`ã§åˆæœŸåŒ–ã®å ´æ‰€ã‚’æŒ‡å®šã§ãã¾ã™ã€‚ä»Šå›ã¯compose upã®éš›ã«apiãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãã“ã«åˆæœŸåŒ–ã•ã›ã¾ã™ã€‚

```bash
docker compose up -d

docker compose exec api hasura init --directory .
```

---
2.2
åˆæœŸåŒ–ãŒæˆåŠŸã—ãŸã‚‰ã€`localhost:8080/console`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦usersã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆã—ã¾ã™ã€‚ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã¯ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã§è¨­å®šã—ãŸADMIN_SECRETãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

ç”»é¢ä¸Šéƒ¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰**DATA**ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ãã®å¾Œã€ŒCreate tableã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚ä»¥ä¸‹ã®ç”»åƒã‚’å‚è€ƒã«ã€usersã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚created_atã¨updated_atã¯ã€ã€ŒFrequently used columnsã€ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚
![image (2)](https://hackmd.io/_uploads/HyzL_ntXJg.png)
![Add Table - Data _ Hasura_page-0001](https://hackmd.io/_uploads/BkO8d2KX1g.jpg)
![image (3)](https://hackmd.io/_uploads/SJ0LOnYXJe.png)

---
2.3
ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç§»è¡Œã¨ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’è¡Œã„ã¾ã™ã€‚å…ˆã»ã©ä½œæˆã—ãŸMakeã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
make db/export
make db/apply
```

### 3. GraphQL Code Generatorã®å°å…¥
3.1
Hasuraã¨Next.jsã®ç’°å¢ƒãŒæ•´ã£ãŸã®ã§ã€æœ€å¾Œã«Code Generatorã§è‡ªå‹•ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
docker compose run --rm app npm install --save-dev \
  @graphql-codegen/cli \
  graphql \
  @graphql-codegen/client-preset \
  @graphql-codegen/typescript \
  @graphql-codegen/typescript-graphql-request \
  @graphql-codegen/typescript-operations \
  @graphql-codegen/typescript-react-apollo \
  prettier
```

---
3.2
æ¬¡ã«ã€Code Generatorã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚å¯¾è©±å‹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã«å¾“ã„ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

```bash
docker compose run app npx graphql-codegen init

    Welcome to GraphQL Code Generator!
    Answer few questions and we will setup everything for you.
  
? What type of application are you building? Application built with React
? Where is your schema?: (path or url) http:localhost:8080
? Where are your operations and fragments?: src/gql/*.gql
? Where to write the output: type/
? Do you want to generate an introspection file? Yes
? How to name the config file? codegen.ts
? What script in package.json should run the codegen? codegen
Fetching latest versions of selected plugins...
```

initå¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
(ä»¥ä¸‹ã€codegen.tsã®å†…å®¹)
```
import { config as dotenvConfig } from "dotenv";
import { CodegenConfig } from "@graphql-codegen/cli";

dotenvConfig();

const config: CodegenConfig = {
  overwrite: true,
  schema: [
    {
      "http://api:8080/v1/graphql": {
        headers: {
          "x-hasura-admin-secret":
            process.env.HASURA_GRAPHQL_ADMIN_SECRET || "",
        },
      },
    },
  ],
  documents: "src/gql/*.gql",
  hooks: {
    afterAllFileWrite: ["prettier --write"],
  },
  generates: {
    "./src/type/graphql.ts": {
      plugins: [
        "typescript",
        "typescript-operations",
        "typescript-react-apollo",
      ],
      config: {
        namingConvention: {
          typeNames: "change-case-all#pascalCase",
          enumValues: "change-case-all#camelCase",
          fieldNames: "change-case-all#camelCase",
        },
        transformUnderscore: "true",
        gqlImport: "@apollo/client#gql",
        withHooks: false,
        withHOC: false,
        withComponent: false,
      },
    },
  },
};

export default config;
```

---

3.3
GraphQLã‚¯ã‚¨ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
mkdir gql
cd gql
touch users.gql
```

(ä»¥ä¸‹ã€users.gqlã®å†…å®¹)
```
query GetUsers {
  users {
    id
    name
    created_at
    updated_at
  }
}

mutation CreateUser($name: String!) {
  insert_users_one(object: {name: $name}) {
    id
    name
  }
}

mutation UpdateUser($id: Int!, $name: String!) {
  update_users_by_pk(pk_columns: {id: $id}, _set: {name: $name}) {
    id
    name
  }
}

mutation DeleteUser($id: Int!) {
  delete_users_by_pk(id: $id) {
    id
    name
  }
}
```

---

3.4
ESLintã®è¨­å®šã‚’ä¿®æ­£ã—ã¾ã™ã€‚

(ä»¥ä¸‹ã€.eslintrc.jsonã®å†…å®¹)
```
{
  "extends": ["next/core-web-vitals", "next/typescript"],
  "overrides": [
    {
      "files": ["app/src/type/*"],
      "rules": {
        "no-unused-vars": "off",
        "other-rule": "off"
      }
    }
  ]
}
```

---

3.5
æœ€å¾Œã«ã€å‹å®šç¾©ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚

```bash
make codegen
```

### 4. å‹•ä½œç¢ºèª
4.1
src/pagesã«ã‚ã‚‹_app.tsxã¨index.tsxã‚’ä¿®æ­£ã—ã¾ã™ã€‚app.tsxã§ApolloProviderã§å›²ã¾ãªã„ã¨ã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ãã¦ã—ã¾ã†ã®ã§å¿˜ã‚Œãšã«è¡Œã„ã¾ã—ã‚‡ã†ã€‚

(ä»¥ä¸‹ã€_app.tsxã®å†…å®¹)
```
import "@/styles/globals.css";
import type { AppProps } from "next/app";
import { ApolloProvider, ApolloClient, InMemoryCache } from "@apollo/client";
import { GraphQLWsLink } from "@apollo/client/link/subscriptions";
import { createClient } from "graphql-ws";

const wsClient = createClient({
  url: process.env.WS_API_URL + "/v1/graphql",
  connectionParams: {
    headers: {
      "x-hasura-admin-secret": process.env.HASURA_GRAPHQL_ADMIN_SECRET,
    },
  },
});
// ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å«ã‚“ã  websocket ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
const wsLink = new GraphQLWsLink(wsClient);

// Apollo client ã‚’ä½œæˆ
const client = new ApolloClient({
  link: wsLink,
  cache: new InMemoryCache(),
});

export default function App({ Component, pageProps }: AppProps) {
  return (
    <ApolloProvider client={client}>
      <Component {...pageProps} />
    </ApolloProvider>
  );
}
```

(ä»¥ä¸‹ã€index.tsxã®å†…å®¹)
```
import { useSubscription, useMutation } from "@apollo/client";
import {
  SubscriptionUsersSubscription,
  CreateUserMutation,
  UpdateUserMutation,
  DeleteUserMutation,
  SubscriptionUsersDocument,
  CreateUserDocument,
  UpdateUserDocument,
  DeleteUserDocument,
} from "@/type/graphql";
import { useState } from "react";

const Page = () => {
  const { data, loading, error } =
    useSubscription<SubscriptionUsersSubscription>(SubscriptionUsersDocument);
  const [createUser] = useMutation<CreateUserMutation>(CreateUserDocument);
  const [updateUser] = useMutation<UpdateUserMutation>(UpdateUserDocument);
  const [deleteUser] = useMutation<DeleteUserMutation>(DeleteUserDocument);

  const [newName, setNewName] = useState<string>("");
  const [editId, setEditId] = useState<number | null>(null);
  const [editName, setEditName] = useState<string>("");

  const handleCreateUser = async () => {
    if (!newName) return;
    try {
      await createUser({ variables: { name: newName } });
      setNewName("");
    } catch (err) {
      console.error("Error creating user:", err);
    }
  };

  const handleEdit = (id: number, name: string) => {
    setEditId(id);
    setEditName(name);
  };

  const handleUpdateUser = async () => {
    if (editId === null || !editName) return;
    try {
      await updateUser({ variables: { id: editId, name: editName } });
      setEditId(null);
      setEditName("");
    } catch (err) {
      console.error("Error updating user:", err);
    }
  };

  const handleDeleteUser = async (id: number) => {
    try {
      await deleteUser({ variables: { id } });
    } catch (err) {
      console.error("Error deleting user:", err);
    }
  };

  if (loading) return <>loading...</>;
  if (error) return <p>Error: {error.message}</p>;

  return (
    <div>
      <h1>Users</h1>

      <div>
        <input
          type="text"
          value={newName}
          onChange={(e) => setNewName(e.target.value)}
          placeholder="Enter name"
        />
        <button onClick={handleCreateUser}>Create User</button>
      </div>

      <ul>
        {data?.users.map((user) => (
          <li key={user.id}>
            {editId === user.id ? (
              <div>
                <input
                  type="text"
                  value={editName}
                  onChange={(e) => setEditName(e.target.value)}
                  placeholder="Edit name"
                />
                <button onClick={handleUpdateUser}>Save</button>
                <button onClick={() => setEditId(null)}>Cancel</button>
              </div>
            ) : (
              <div>
                <span>{user.name}</span>
                <button onClick={() => handleEdit(user.id, user.name)}>
                  Edit
                </button>
                <button onClick={() => handleDeleteUser(user.id)}>
                  Delete
                </button>
              </div>
            )}
          </li>
        ))}
      </ul>
    </div>
  );
};

export default Page;
```

---

4.2
ä¸Šè¨˜ã®ã‚ˆã†ã«ä¿®æ­£ã—ãŸã‚‰`localhost:3000` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å‹•ä½œç¢ºèªã—ã¾ã™ã€‚

cssã‚’æ›¸ã„ã¦ã„ãªã„ã®ã§ã¨ã¦ã‚‚ç°¡ç´ ãªã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ãŒãƒ¦ãƒ¼ã‚¶ã®ä½œæˆã€ç·¨é›†ã€å‰Šé™¤ã‚’è¡Œã†ã¨ãã‚ŒãŒå³åº§ã«åæ˜ ã•ã‚Œã¦ã„ãŸã‚‰websocketãŒå‹•ã„ã¦ã„ã‚‹ã®ã§æˆåŠŸã«ãªã‚Šã¾ã™ã€‚
![image (4)](https://hackmd.io/_uploads/Hy7-52Ym1e.png)

---

### ç’°å¢ƒæ§‹ç¯‰ä¸­ã«ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦
è‡ªå‹•ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ãŒrootã«ãªã£ã¦ã„ã¾ã—ãŸã€‚
ãã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ¨©é™ã‚’å¤‰æ›´ã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚
```bash
sudo chown -R {name}:{name} {folder_name}
sudo chmod 755 {file_name}
```

## ä½™è«‡
BINGOãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’ã¯ã˜ã‚ã¦2å¹´ãŒçµŒã¡ã¾ã™ãŒcode geneaterã‚’å°å…¥ã—ãŸã®ã¯ä»Šå¹´ã‹ã‚‰ã§ã—ãŸã€‚ãªã®ã§ã›ã£ã‹ããªã®ã§å°å…¥å‰ã¨å¾Œã®æ¯”è¼ƒã‚’è¡Œã„ã€è‡ªå‹•ç”Ÿæˆã¯ä½¿ã†ã¹ãã¨ã„ã†æ•™è¨“ã‚’çš†æ§˜ã«å…±æœ‰ã—ã¾ã™ã€‚

æ­£ç›´ä»Šã‚‚Graphql APIã¨REST APIã®é•ã„ã¯åˆ†ã‹ã‚‰ãšã«ä½¿ã£ã¦ã„ã¾ã™ãŒåˆæœŸã®é ƒã¯api_methodsã‚’ä½œæˆã—ã¦ã„ã¾ã—ãŸã€‚pageã§ã¯é–¢æ•°ã ã‘å‘¼ã³å‡ºã—ã¦ä½¿ã„ãŸã„ãŸã‚ã“ã“ã§Promiseã®å‡¦ç†ã‚’æ›¸ã„ãŸã‚Šã€å‹å®šç¾©ã‚’ã—ãŸã‚Šã¨æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚

ã—ã‹ã—ã€generaterã‚’å°å…¥ã—ã¦ã‹ã‚‰ã¯ã‚¯ã‚¨ãƒªã‚’å®šç¾©ã™ã‚‹ã ã‘TSã«å¿…è¦ãªå‹å®šç¾©ã‚„apollo clientã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ãŒç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã›ã£ã‹ãAPIã‚’hasuraãŒç°¡å˜ã«å®Ÿè£…ã—ã¦ãã‚Œã‚‹ã®ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¸ã®ç¹‹ãè¾¼ã¿ã§æ™‚é–“ãŒã‹ã‹ã‚‹å•é¡Œã‚’è§£æ±ºã™ã‚‹ã«è‡³ã‚Šã¾ã—ãŸã€‚

å°å…¥å‰ã®AP
/src/utils/api_methods.ts
```
import { ApolloClient, InMemoryCache, gql} from "@apollo/client";
import next from "next/types";
import { GraphQLWsLink } from '@apollo/client/link/subscriptions';
import { createClient } from "graphql-ws";
import { userAgent } from "next/server";

const wsLink = new GraphQLWsLink(createClient({
  url: process.env.WS_API_URL + "/v1/graphql",
    // èªè¨¼é–¢é€£ã¯ã“ã“ã«æ›¸ã
}));

const client = new ApolloClient({
  link: wsLink,
  cache: new InMemoryCache(),
});

export interface BingoNumber {
  id: number;
  data: number;
}

// GraphQLã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
export async function getBingoNumber(): Promise<BingoNumber[]> {
  try {
    const response = await client.query({
      query: gql`
        query MyQuery {
          bingo_number {
            data
            id
          }
        }
      `,
    });
    return response.data.bingo_number;
  } catch (error) {
    console.error("Error fetching data:", error);
    return []
  }
}

// websocketé€šä¿¡ã§BingoNumberã‚’å–å¾—
export async function subscriptionBingoNumber(): Promise<BingoNumber[]> {
  try {
    const response = await client.subscribe({
      query: gql`
        subscription MySubscription {
          bingo_number {
            data
            id
          }
        }
      `,
    });
    return new Promise<BingoNumber[]>((resolve, reject) => {
      response.subscribe({
        next: data => resolve(data.data.bingo_number),
        error: error => {
          console.error('Subscription error:', error);
          reject(error);
        },
      });
    });
  } catch (error) {
    console.error('Error fetching data:', error);
    return [];
  }
}

export async function createBingoNumber(
  data: number
): Promise<BingoNumber[]> {
  try {
    const response = await client.mutate({
      mutation: gql`
        mutation MyMutation($data: Int!) {
          insert_bingo_number_one(object: { data: $data }) {
            id
          }
        }
      `,
      variables: { data },
    });

    return response.data.insert_bingo_number_one;
  } catch (error) {
    console.error("Error creating bingo number:", error);
    return []
  }
}

export async function deleteBingoNumber(
  data: number
): Promise<BingoNumber[]> {
  try {
    const response = await client.mutate({
      mutation: gql`
        mutation MyMutation($data: Int!) {
          delete_bingo_number(where: { data: { _eq: $data } }) {
            affected_rows
          }
        }
      `,
      variables: { data },
    });

    return response.data.delete_bingo_number;
  } catch (error) {
    console.error("Error deleteing bingo number:", error);
    return []
  }
}
```

å°å…¥å¾Œã®API
src/gql/numbers.gql
```
# ç•ªå·ã®å–å¾—(Get)
query GetListNumbers {
  numbers {
    id
    number
    createdAt
    updatedAt
  }
}

# ç•ªå·ã®è¿½åŠ (Create)
mutation CreateOneNumber($number: Int!) {
  insertNumbersOne(object: { number: $number }) {
    id
  }
}

# ç•ªå·ã®å‰Šé™¤(Delete)
mutation DeleteOneNumber($number: Int!) {
  deleteNumbers(where: { number: { _eq: $number } }) {
    affectedRows
  }
}

# ç•ªå·ã®ç¶™ç¶šå–å¾—(Subscription)
subscription SubscribeListNumbers {
  numbers {
    id
    number
    createdAt
    updatedAt
  }
}
```


## ãŠã‚ã‚Šã«
ã“ã“ã¾ã§ã”ä¸€èª­ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚èª°ã‹ã®é–‹ç™ºã®ãƒ’ãƒ³ãƒˆã«ãªã£ã¦ã„ã‚Œã°å¹¸ã„ã§ã™ã€‚

ç§äº‹ã«ãªã‚Šã¾ã™ãŒã€NUTMEGã¯ä»Šå¹´ã‚‚å¤šãã®æ–°å…¥ç”Ÿã«æµã¾ã‚Œæ´»æ°—ã®ã‚ã‚‹å›£ä½“ã«ãªã‚Šã¾ã—ãŸã€‚ä»–å±€ã¨ã®ä¿¡é ¼é–¢ä¿‚ã‚‚ä¸€å±¤å¼·ã¾ã‚Šãƒ’ã‚¢ãƒªãƒ³ã‚°ã«å¯¾ã—ã¦çœŸæ‘¯ã«å¯¾å¿œã—ã¦ãã ã•ã‚‹ãŠã‹ã’ã§æ²¢å±±ã®ä¿®æ­£äº‹é …ã‚„æ”¹å–„äº‹é …ã‚’é ‚ãã¾ã—ãŸã€‚ä»Šã®æ–°å…¥ç”Ÿã®å‹¢ã„ã«è² ã‘ãªã„ã‚ˆã†ã«å¯„ã‚Šã‚ˆã‚Šãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’å®Ÿç¾ãƒ»æä¾›ã§ãã‚‹ã‚ˆã†ã«æ´»å‹•ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

æœ€å¾Œã«è¨€ã„ãŸã‹ã£ãŸã“ã¨ã¨ã—ã¦ã€çš†ã•ã‚“æ˜¯éGeneraterã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã‚’ã†ã¾ãæ´»ç”¨ã—ã¦è‰¯ã„é–‹ç™ºãƒ©ã‚¤ãƒ•ã‚’ãŠé€ã‚Šãã ã•ã„ã€‚ä»Šã®æ™‚ä»£ã€æ´»ç”¨ã—ãŸã‚‚ã®å‹ã¡ã§ã™ã€‚